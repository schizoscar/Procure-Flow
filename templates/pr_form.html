<!-- templates/pr_form.html -->
{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>{% if is_edit %}Edit{% else %}New{% endif %} Purchase Requisition</h2>
        <p>Step 1: {% if is_edit %}Update{% else %}Fill out{% endif %} the purchase requisition form</p>
    </div>
    <div class="card-body">
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="progress-step active">1</div>
            <div class="progress-step">2</div>
            <div class="progress-step">3</div>
            <div class="progress-step">4</div>
        </div>

        <form method="POST">
            <div class="form-group">
                <label class="form-label required">Task Name</label>
                <input type="text" class="form-control" name="task_name" required 
                       value="{{ task.task_name if task else '' }}"
                       placeholder="Enter task name (e.g., Office Supplies Q4 2024)">
            </div>

            <div class="items-container" id="itemsContainer" style="max-height: 60vh; overflow-y: auto; position: relative;">
                {% if existing_items %}
                    {% for item in existing_items %}
                    <div class="card mb-2 item-row">
                        <div class="d-flex justify-between align-center">
                            <h4>Item {{ loop.index }}</h4>
                            {% if existing_items|length > 1 %}
                            <button type="button" class="btn btn-danger remove-item">
                                <i class="fas fa-times"></i> Remove
                            </button>
                            {% endif %}
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label required">Item Name</label>
                                <input type="text" class="form-control" name="items[{{ loop.index0 }}][item_name]" 
                                       value="{{ item.item_name }}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Quantity</label>
                                <input type="number" class="form-control" name="items[{{ loop.index0 }}][quantity]" 
                                       value="{{ item.quantity }}" min="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Specification</label>
                                <input type="text" class="form-control" name="items[{{ loop.index0 }}][specification]" 
                                       value="{{ item.specification or '' }}" placeholder="Technical specifications">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Width</label>
                                <input type="text" class="form-control" name="items[{{ loop.index0 }}][width]" 
                                       value="{{ item.width or '' }}" placeholder="e.g., 10mm">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Length</label>
                                <input type="text" class="form-control" name="items[{{ loop.index0 }}][length]" 
                                       value="{{ item.length or '' }}" placeholder="e.g., 100cm">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Thickness</label>
                                <input type="text" class="form-control" name="items[{{ loop.index0 }}][thickness]" 
                                       value="{{ item.thickness or '' }}" placeholder="e.g., 5mm">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Brand</label>
                                <input type="text" class="form-control" name="items[{{ loop.index0 }}][brand]" 
                                       value="{{ item.brand or '' }}" placeholder="Preferred brand">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Balance Stock</label>
                                <input type="number" class="form-control" name="items[{{ loop.index0 }}][balance_stock]" 
                                       value="{{ item.balance_stock or 0 }}" min="0" placeholder="Current stock level">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Terms</label>
                                <input type="text" class="form-control" name="items[{{ loop.index0 }}][payment_terms]" 
                                       value="{{ item.payment_terms or '' }}" placeholder="e.g., 30 days credit">
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Item Category</label>
                                <select class="form-control form-select" name="items[{{ loop.index0 }}][item_category]" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.name }}" {% if item.item_category == category.name %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <!-- First item row -->
                <div class="card mb-2 item-row">
                    <div class="d-flex justify-between align-center">
                        <h4>Item 1</h4>
                        <!-- No remove button for the first item when there's only one -->
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label required">Item Name</label>
                            <input type="text" class="form-control" name="items[0][item_name]" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Quantity</label>
                            <input type="number" class="form-control" name="items[0][quantity]" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Specification</label>
                            <input type="text" class="form-control" name="items[0][specification]" 
                                   placeholder="Technical specifications">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Width</label>
                            <input type="text" class="form-control" name="items[0][width]" 
                                   placeholder="e.g., 10mm">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Length</label>
                            <input type="text" class="form-control" name="items[0][length]" 
                                   placeholder="e.g., 100cm">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Thickness</label>
                            <input type="text" class="form-control" name="items[0][thickness]" 
                                   placeholder="e.g., 5mm">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Brand</label>
                            <input type="text" class="form-control" name="items[0][brand]" 
                                   placeholder="Preferred brand">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Balance Stock</label>
                            <input type="number" class="form-control" name="items[0][balance_stock]" min="0" 
                                   placeholder="Current stock level">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Terms</label>
                            <input type="text" class="form-control" name="items[0][payment_terms]" 
                                   placeholder="e.g., 30 days credit">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Item Category</label>
                            <select class="form-control form-select" name="items[0][item_category]" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.name }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <button type="button" id="addItem" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Add Another Item
            </button>

            <div class="d-flex gap-1 mt-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% if is_edit %}Save & Continue{% else %}Continue to Supplier Selection{% endif %}
                </button>
                {% if is_edit %}
                <a href="{{ url_for('task_list') }}" class="btn btn-secondary">Cancel</a>
                {% else %}
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    console.log('PR Form Script Loading...');

    let initializationCount = 0;

    document.addEventListener('DOMContentLoaded', function () {
        initializationCount++;
        console.log('DOM Content Loaded - Initialization #:', initializationCount);

        let itemCount = {{ existing_items| length if existing_items else 1
    }};
    console.log('Initial itemCount:', itemCount);

    // Remove ALL existing event listeners from the add button
    const addButton = document.getElementById('addItem');
    if (addButton) {
        console.log('Add button found, replacing it...');
        const newAddButton = addButton.cloneNode(true);
        addButton.parentNode.replaceChild(newAddButton, addButton);

        let clickCount = 0;
        newAddButton.addEventListener('click', function (e) {
            clickCount++;
            console.log('Add button clicked - Click #:', clickCount);
            e.preventDefault();
            e.stopPropagation();

            itemCount++;
            console.log('Adding item #:', itemCount);

            let categoriesOptions = '<option value="">Select Category</option>';
            {% for category in categories %}
            categoriesOptions += '<option value="{{ category.name }}">{{ category.name }}</option>';
            {% endfor %}

            const newItem = `
                <div class="card mb-2 item-row">
                    <div class="d-flex justify-between align-center">
                        <h4>Item ${itemCount}</h4>
                        <button type="button" class="btn btn-danger remove-item">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label required">Item Name</label>
                            <input type="text" class="form-control" name="items[${itemCount - 1}][item_name]" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Quantity</label>
                            <input type="number" class="form-control" name="items[${itemCount - 1}][quantity]" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Specification</label>
                            <input type="text" class="form-control" name="items[${itemCount - 1}][specification]" 
                                   placeholder="Technical specifications">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Width</label>
                            <input type="text" class="form-control" name="items[${itemCount - 1}][width]" 
                                   placeholder="e.g., 10mm">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Length</label>
                            <input type="text" class="form-control" name="items[${itemCount - 1}][length]" 
                                   placeholder="e.g., 100cm">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Thickness</label>
                            <input type="text" class="form-control" name="items[${itemCount - 1}][thickness]" 
                                   placeholder="e.g., 5mm">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Brand</label>
                            <input type="text" class="form-control" name="items[${itemCount - 1}][brand]" 
                                   placeholder="Preferred brand">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Balance Stock</label>
                            <input type="number" class="form-control" name="items[${itemCount - 1}][balance_stock]" min="0" 
                                   placeholder="Current stock level">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Terms</label>
                            <input type="text" class="form-control" name="items[${itemCount - 1}][payment_terms]" 
                                   placeholder="e.g., 30 days credit">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Item Category</label>
                            <select class="form-control form-select" name="items[${itemCount - 1}][item_category]" required>
                                ${categoriesOptions}
                            </select>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('itemsContainer').insertAdjacentHTML('beforeend', newItem);
            updateItemNumbers();
        });
    }

    // Rest of your functions...
    document.getElementById('itemsContainer').addEventListener('click', function(e) {
        if (e.target.closest('.remove-item')) {
            e.preventDefault();
            const row = e.target.closest('.item-row');
            if (row) {
                row.remove();
                updateItemNumbers();
            }
        }
    });

    function updateItemNumbers() {
        const items = document.querySelectorAll('.item-row');
        console.log('Current items count:', items.length);
        let currentCount = 0;
        items.forEach((item) => {
            currentCount++;
            const title = item.querySelector('h4');
            if (title) {
                title.textContent = `Item ${currentCount}`;
            }
        });
        itemCount = currentCount;
    }

    updateItemNumbers();
});
</script>
{% endblock %}
