<!-- templates/email_confirmation.html -->
{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Send Emails</h2>
        <p>Final Step: Confirm and send emails for {{ task.task_name }}</p>
    </div>
    <div class="card-body">
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="progress-step completed">1</div>
            <div class="progress-step completed">2</div>
            <div class="progress-step completed">3</div>
            <div class="progress-step completed">4</div>
        </div>

        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle"></i> Ready to Send Emails</h5>
            <p class="mb-0">You are about to send procurement inquiries to {{ suppliers|length }} supplier(s).</p>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-paper-plane"></i> Email Summary</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Recipients</h5>
                        <ul class="recipient-list">
                            {% for supplier in suppliers %}
                            <li>
                                <strong>{{ supplier.name }}</strong><br>
                                <small>{{ supplier.email }}</small>
                                {% if supplier.contact_name %}
                                <br><small>Contact: {{ supplier.contact_name }}</small>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Items</h5>
                        <ul class="items-list">
                            {% for item in pr_items %}
                                {% set cat = item.item_category %}
                                <li>
                                    <div style="font-weight:600;">
                                        {{ loop.index }}. {{ item.item_name }}
                                        {% if item.brand %}- {{ item.brand }}{% endif %}
                                        {{ item.specification or '' }}
                                    </div>

                                    <div style="font-size:0.9rem; opacity:0.9; margin-top:0.15rem;">
                                        {% if cat in ['Steel Plates','Stainless Steel'] %}
                                            Sizes:
                                            {{ item.width if item.width is not none else '-' }} mm (W)
                                            × {{ item.length if item.length is not none else '-' }} mm (L)
                                            × {{ item.thickness if item.thickness is not none else '-' }} mm (Thk)

                                        {% elif cat == 'Angle Bar' %}
                                            Sizes:
                                            {{ item.dim_a if item.dim_a is not none else '-' }} mm (A)
                                            × {{ item.dim_b if item.dim_b is not none else '-' }} mm (B)
                                            × {{ item.length if item.length is not none else '-' }} mm (L)
                                            × {{ item.thickness if item.thickness is not none else '-' }} mm (Thk)

                                        {% elif cat in ['Bolts, Fasteners','Rebar','Nuts'] %}
                                            Sizes:
                                            {{ item.diameter if item.diameter is not none else '-' }} mm (D)
                                            × {{ item.length if item.length is not none else '-' }} mm (L)

                                        {% else %}
                                            Packing:
                                            {{ item.uom_qty if item.uom_qty is not none else '-' }}
                                            {{ item.uom if item.uom is not none else '' }}
                                        {% endif %}
                                        &nbsp;•&nbsp; Qty: {{ item.quantity if item.quantity is not none else '-' }}
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <form method="POST">
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" class="checkbox-input" id="confirmSend" required>
                    <label for="confirmSend" class="form-label">
                        I confirm that I want to send procurement inquiries to the selected suppliers
                    </label>
                </div>
            </div>

            <div class="d-flex gap-1">
                <button type="submit" class="btn btn-success" id="sendButton" disabled>
                    <i class="fas fa-paper-plane"></i> Send Emails Now
                </button>
                <a href="{{ url_for('email_preview', task_id=task.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Preview
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const confirmCheckbox = document.getElementById('confirmSend');
        const sendButton = document.getElementById('sendButton');

        confirmCheckbox.addEventListener('change', function () {
            sendButton.disabled = !this.checked;
        });
    });
</script>

<style>
    .recipient-list {
        list-style: none;
        padding: 0;
    }

    .recipient-list li {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid var(--dusty-purple);
    }
</style>
{% endblock %}