{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Capture Quote - {{ supplier.name }}</h2>
        <p>Task: {{ task.task_name }}</p>
    </div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">Payment Terms</label>
                <input type="text" class="form-control" name="payment_terms" value="{{ payment_terms_default or '' }}" placeholder="e.g., 30 days credit">
            </div>
            {% for item in pr_items %}
            {% set existing = quotes_map.get(item.id) %}
            <div class="card mb-2" style="border:1px solid #e0e0e0;">
                <div class="card-header">
                    <h4>Item {{ loop.index }}: {{ item.item_name }}</h4>
                    <p class="text-muted">
                        {{ item.specification or '' }}
                        {% if item.width or item.length or item.thickness %}
                            <br>Dims: {{ item.width or '-' }} x {{ item.length or '-' }} x {{ item.thickness or '-' }}
                        {% endif %}
                    </p>
                </div>
                <div class="card-body grid-2">
                    <div class="form-group">
                        <label class="form-label">Unit Price (RM)</label>
                        <input type="number" step="0.01" min="0" class="form-control" name="unit_price_{{ item.id }}" value="{{ existing.unit_price if existing else '' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Delivery Lead Time</label>
                        <input type="text" class="form-control" name="lead_time_{{ item.id }}" value="{{ existing.lead_time if existing else '' }}" placeholder="e.g. 14 days">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Availability</label>
                        <input type="text" class="form-control" name="stock_availability_{{ item.id }}" placeholder="e.g., 10 in stock or Available">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Warranty (If Applicable)</label>
                        <input type="text" class="form-control" name="warranty_{{ item.id }}" placeholder="e.g., 1 year">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mill Certificate / Certificate of Analysis (COA)</label>
                        <input type="file" class="form-control" name="cert_{{ item.id }}" accept=".pdf" id="cert_{{ item.id }}">
                        <small class="text-muted">PDF files only</small>
                        {% if existing and existing.cert %}
                            <div style="margin-top:0.5rem;">
                                <small class="text-muted">Current: <a href="{{ existing.cert }}" target="_blank">View file</a></small>
                            </div>
                        {% endif %}
                        <div id="cert_filename_{{ item.id }}" style="margin-top:0.5rem;display:none;">
                            <small class="text-success"><i class="fas fa-check"></i> <span id="cert_name_{{ item.id }}"></span></small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">O.N.O.</label>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <input type="checkbox" name="ono_{{ item.id }}" {% if existing and existing.ono %}checked{% endif %}>
                            <span>On Nearest Offer</span>
                        </div>
                    </div>
                    <div class="form-group" id="ono_dims_{{ item.id }}" style="display:none;">
                        <label class="form-label">O.N.O. Dimensions (mm)</label>
                        <div style="display:flex;gap:0.5rem;align-items:center;">
                            <input type="number" step="1" min="0" class="form-control" name="ono_width_{{ item.id }}" id="ono_width_{{ item.id }}" placeholder="Width (mm)">
                            <input type="number" step="1" min="0" class="form-control" name="ono_length_{{ item.id }}" id="ono_length_{{ item.id }}" placeholder="Length (mm)">
                            <input type="number" step="1" min="0" class="form-control" name="ono_thickness_{{ item.id }}" id="ono_thickness_{{ item.id }}" placeholder="Thickness (mm)">
                        </div>
                        <small class="text-muted">If provided, a new item entry will be created for these dimensions and used in comparison.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remarks</label>
                        <input type="text" class="form-control" name="notes_{{ item.id }}" value="{{ existing.notes if existing else '' }}">
                    </div>
                </div>
            </div>
            {% endfor %}
            <div class="d-flex gap-1 mt-2">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Quotes</button>
                <a href="{{ url_for('task_responses', task_id=task.id) }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle file input change to display filename
    {% for item in pr_items %}
    const certInput_{{ item.id }} = document.getElementById('cert_{{ item.id }}');
    if (certInput_{{ item.id }}) {
        certInput_{{ item.id }}.addEventListener('change', function() {
            const filenameDiv = document.getElementById('cert_filename_{{ item.id }}');
            const filenameSpan = document.getElementById('cert_name_{{ item.id }}');
            if (this.files && this.files.length > 0) {
                filenameSpan.textContent = this.files[0].name;
                filenameDiv.style.display = 'block';
            } else {
                filenameDiv.style.display = 'none';
            }
        });
    }
    {% endfor %}
});
</script>
{% endblock %}
