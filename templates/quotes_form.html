{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Capture Quote - {{ supplier.name }}</h2>
        <p>Task: {{ task.task_name }}</p>
    </div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">Payment Terms (Days)</label>
                <input type="text" class="form-control" name="payment_terms" value="{{ payment_terms_default or '' }}" placeholder="e.g., 30 days credit">
            </div>
            {% for item in pr_items %}
            {% set existing = quotes_map.get(item.id) %}
            <div class="card mb-2" style="border:1px solid #e0e0e0;">
                <div class="card-header">
                    <h4>Item {{ loop.index }}: {{ item.item_name }}</h4>
                    <p class="text-muted">
                        {{ item.specification or '' }}

                        {% set cat = item.item_category %}

                        {% if cat in ['Steel Plates','Stainless Steel'] %}
                            <br>
                            Dims (W × L × Thk): {{ item.width if item.width is not none else '-' }}
                            x {{ item.length if item.length is not none else '-' }}
                            x {{ item.thickness if item.thickness is not none else '-' }} mm

                        {% elif cat == 'Angle Bar' %}
                            <br>
                            Dims (A × B × L × Thk): {{ item.dim_a if item.dim_a is not none else '-' }}
                            x {{ item.dim_b if item.dim_b is not none else '-' }}
                            x {{ item.length if item.length is not none else '-' }}
                            x {{ item.thickness if item.thickness is not none else '-' }} mm

                        {% elif cat in ['Bolts, Fasteners','Rebar','Nuts'] %}
                            <br>
                            Dims (D × L): {{ item.diameter if item.diameter is not none else '-' }}
                            x {{ item.length if item.length is not none else '-' }} mm

                        {% else %}
                            <br>
                            Packing: {{ item.uom_qty if item.uom_qty is not none else '-' }}
                            {{ item.uom if item.uom is not none else '' }}
                        {% endif %}
                    </p>
                </div>
                <div class="card-body grid-2">
                    <div class="form-group">
                        <label class="form-label">Unit Price (RM)</label>
                        <input type="number" step="0.01" min="0" class="form-control" name="unit_price_{{ item.id }}" value="{{ existing.unit_price if existing else '' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Delivery Lead Time (Days)</label>
                        <input type="text" class="form-control" name="lead_time_{{ item.id }}" value="{{ existing.lead_time if existing else '' }}" placeholder="e.g. 14 days">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Availability</label>
                        <input type="text" class="form-control" name="stock_availability_{{ item.id }}" value="{{ existing.stock_availability if existing else '' }}" placeholder="e.g., 10 in stock or Available">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Warranty (If Applicable)</label>
                        <input type="text" class="form-control" name="warranty_{{ item.id }}" placeholder="e.g., 1 year">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mill Certificate / Certificate of Analysis (COA)</label>
                        <input type="file" class="form-control" name="cert_{{ item.id }}" accept=".pdf" id="cert_{{ item.id }}">
                        <small class="text-muted">PDF files only</small>
                        {% if existing and existing.cert %}
                            <div style="margin-top:0.5rem;">
                                <small class="text-muted">Current: <a href="{{ existing.cert }}" target="_blank">View file</a></small>
                            </div>
                        {% endif %}
                        <div id="cert_filename_{{ item.id }}" style="margin-top:0.5rem;display:none;">
                            <small class="text-success"><i class="fas fa-check"></i> <span id="cert_name_{{ item.id }}"></span></small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">O.N.O.</label>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <input type="checkbox"
                                class="ono-checkbox"
                                name="ono_{{ item.id }}"
                                data-item-id="{{ item.id }}"
                                data-dim-type="{% if item.item_category in ['Steel Plates','Stainless Steel'] %}steel-plates{% elif item.item_category == 'Angle Bar' %}angle-bar{% elif item.item_category in ['Bolts, Fasteners','Rebar'] %}bolts-rebar{% else %}other{% endif %}"
                                {% if existing and existing.ono %}checked{% endif %}>
                            <span>On Nearest Offer</span>
                        </div>
                    </div>

                    <div class="form-group ono-dims-wrap" id="ono_dims_{{ item.id }}" style="display:none;">
                        <label class="form-label">O.N.O. Dimensions</label>

                        <!-- Steel Plates / Stainless Steel: W, L, Thk -->
                        <div class="ono-dims-section ono-steel-plates" style="display:none;">
                            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:0.5rem; align-items:center;">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_width_{{ item.id }}" id="ono_width_{{ item.id }}"
                                    value="{{ existing.ono_width if existing else '' }}"
                                    placeholder="Width (mm)">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_length_{{ item.id }}" id="ono_length_{{ item.id }}"
                                    value="{{ existing.ono_length if existing else '' }}"
                                    placeholder="Length (mm)">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_thickness_{{ item.id }}" id="ono_thickness_{{ item.id }}"
                                    value="{{ existing.ono_thickness if existing else '' }}"
                                    placeholder="Thickness (mm)">
                            </div>
                        </div>

                        <!-- Angle Bar: A, B, L, Thk -->
                        <div class="ono-dims-section ono-angle-bar" style="display:none;">
                            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:0.5rem; align-items:center;">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_dim_a_{{ item.id }}" id="ono_dim_a_{{ item.id }}"
                                    value="{{ existing.ono_dim_a if existing and existing.ono_dim_a is defined else '' }}"
                                    placeholder="A (mm)">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_dim_b_{{ item.id }}" id="ono_dim_b_{{ item.id }}"
                                    value="{{ existing.ono_dim_b if existing and existing.ono_dim_b is defined else '' }}"
                                    placeholder="B (mm)">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_length_{{ item.id }}" id="ono_length_{{ item.id }}"
                                    value="{{ existing.ono_length if existing else '' }}"
                                    placeholder="Length (mm)">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_thickness_{{ item.id }}" id="ono_thickness_{{ item.id }}"
                                    value="{{ existing.ono_thickness if existing else '' }}"
                                    placeholder="Thickness (mm)">
                            </div>
                        </div>

                        <!-- Bolts / Rebar: D, L -->
                        <div class="ono-dims-section ono-bolts-rebar" style="display:none;">
                            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:0.5rem; align-items:center;">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_diameter_{{ item.id }}" id="ono_diameter_{{ item.id }}"
                                    value="{{ existing.ono_diameter if existing and existing.ono_diameter is defined else '' }}"
                                    placeholder="Diameter (mm)">
                                <input type="number" step="1" min="0" class="form-control"
                                    name="ono_length_{{ item.id }}" id="ono_length_{{ item.id }}"
                                    value="{{ existing.ono_length if existing else '' }}"
                                    placeholder="Length (mm)">
                            </div>
                        </div>

                        <!-- Other: UOM Amount + UOM -->
                        <div class="ono-dims-section ono-other" style="display:none;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem; align-items:center;">
                                <input type="number" step="1" min="1" class="form-control"
                                    name="ono_uom_qty_{{ item.id }}" id="ono_uom_qty_{{ item.id }}"
                                    value="{{ existing.ono_uom_qty if existing and existing.ono_uom_qty is defined else '' }}"
                                    placeholder="UOM Amount">
                                <select class="form-control" name="ono_uom_{{ item.id }}" id="ono_uom_{{ item.id }}">
                                    {% set ou = existing.ono_uom if existing and existing.ono_uom is defined else '' %}
                                    <option value="" {% if ou=='' %}selected{% endif %}>Select UOM</option>
                                    <option value="pcs" {% if ou=='pcs' %}selected{% endif %}>pcs</option>
                                    <option value="kg" {% if ou=='kg' %}selected{% endif %}>kg</option>
                                    <option value="L" {% if ou=='L' %}selected{% endif %}>L</option>
                                    <option value="unit" {% if ou=='unit' %}selected{% endif %}>unit</option>
                                    <option value="set" {% if ou=='set' %}selected{% endif %}>set</option>
                                    <option value="m" {% if ou=='m' %}selected{% endif %}>m</option>
                                    <option value="roll" {% if ou=='roll' %}selected{% endif %}>roll</option>
                                </select>
                            </div>
                        </div>

                        <small class="text-muted">
                            If provided, a new item entry will be created for these alternate dimensions and used in comparison.
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remarks</label>
                        <input type="text" class="form-control" name="notes_{{ item.id }}" value="{{ existing.notes if existing else '' }}">
                    </div>
                </div>
            </div>
            {% endfor %}
            <div class="d-flex gap-1 mt-2">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Quotes</button>
                <a href="{{ url_for('task_responses', task_id=task.id) }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    function setEnabled(el, enabled) {
        el.querySelectorAll('input, select, textarea').forEach(inp => {
            inp.disabled = !enabled;
        });
    }

    function showONOForItem(itemId, dimType) {
        const wrap = document.getElementById('ono_dims_' + itemId);
        if (!wrap) return;

        const sections = wrap.querySelectorAll('.ono-dims-section');

        // Hide + disable all sections first
        sections.forEach(sec => {
            sec.style.display = 'none';
            setEnabled(sec, false);
        });

        // Show + enable only the correct one
        const target = wrap.querySelector('.ono-' + dimType);
        if (target) {
            target.style.display = 'block';
            setEnabled(target, true);
        }
    }

    // Hook up ONO checkboxes
    document.querySelectorAll('.ono-checkbox').forEach(function(cb) {
        const itemId = cb.getAttribute('data-item-id');
        const dimType = cb.getAttribute('data-dim-type') || 'other';
        const wrap = document.getElementById('ono_dims_' + itemId);
        if (!wrap) return;

        function sync() {
            if (cb.checked) {
                wrap.style.display = 'block';
                showONOForItem(itemId, dimType);
            } else {
                wrap.style.display = 'none';
                // Disable everything so hidden ONO inputs don't submit blanks
                wrap.querySelectorAll('.ono-dims-section').forEach(sec => setEnabled(sec, false));
            }
        }

        cb.addEventListener('change', sync);
        sync();
    });

});
</script>
{% endblock %}
